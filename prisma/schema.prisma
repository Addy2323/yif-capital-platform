// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  FREE
  PRO
  INSTITUTIONAL
  ADMIN
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
}

model User {
  id              String            @id @default(uuid())
  email           String            @unique
  name            String
  password        String
  role            UserRole          @default(FREE)
  avatar          String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  enrollments     Enrollment[]
  accessTokens    AccessToken[]
  accessLogs      AccessAttemptLog[]
  payments        Payment[]
}

model Enrollment {
  id          String             @id @default(uuid())
  userId      String
  courseId    String
  status      SubscriptionStatus @default(ACTIVE)
  enrolledAt  DateTime           @default(now())
  expiresAt   DateTime?
  
  user        User               @relation(fields: [userId], references: [id])
  payment     Payment?           @relation(fields: [paymentId], references: [id])
  paymentId   String?            @unique

  @@index([userId])
  @@index([courseId])
}

model LiveSession {
  id               String    @id @default(uuid())
  courseId         String
  title            String
  description      String?
  meetingUrl       String?
  scheduledStart   DateTime
  scheduledEnd     DateTime
  status           String    @default("scheduled")
  
  // Pricing
  price            Float     @default(0)
  currency         String    @default("TZS")
  isFree           Boolean   @default(true)
  
  accessTokens     AccessToken[]
  accessLogs       AccessAttemptLog[]
  payments         Payment[]

  @@index([courseId])
  @@index([scheduledStart])
}

model AccessToken {
  id                String    @id @default(uuid())
  tokenHash         String    @unique
  userId            String
  sessionId         String
  deviceFingerprint String
  expiresAt         DateTime
  usedAt            DateTime?
  createdAt         DateTime  @default(now())
  
  user              User        @relation(fields: [userId], references: [id])
  session           LiveSession @relation(fields: [sessionId], references: [id])

  @@index([tokenHash])
  @@index([userId])
  @@index([sessionId])
}

model AccessAttemptLog {
  id                String    @id @default(uuid())
  userId            String?
  sessionId         String?
  ipAddress         String?
  deviceFingerprint String?
  userAgent         String?
  status            String
  reason            String?
  createdAt         DateTime  @default(now())
  
  user              User?        @relation(fields: [userId], references: [id])
  session           LiveSession? @relation(fields: [sessionId], references: [id])

  @@index([userId])
  @@index([sessionId])
  @@index([createdAt])
}

model Payment {
  id                String    @id @default(uuid())
  userId            String
  amount            Float
  currency          String    @default("TZS")
  provider          String
  providerReference String?   @unique
  status            String
  plan              String
  sessionId         String?
  createdAt         DateTime  @default(now())
  completedAt       DateTime?
  
  user              User        @relation(fields: [userId], references: [id])
  session           LiveSession? @relation(fields: [sessionId], references: [id])
  enrollment        Enrollment?

  @@index([sessionId])
}
