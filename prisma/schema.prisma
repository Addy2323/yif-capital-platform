generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String             @id @default(uuid())
  email        String             @unique
  name         String
  password     String
  role         UserRole           @default(FREE)
  avatar       String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  accessLogs   AccessAttemptLog[]
  accessTokens AccessToken[]
  enrollments  Enrollment[]
  payments     Payment[]
}

model Enrollment {
  id         String             @id @default(uuid())
  userId     String
  courseId   String
  status     SubscriptionStatus @default(ACTIVE)
  enrolledAt DateTime           @default(now())
  expiresAt  DateTime?
  paymentId  String?            @unique
  payment    Payment?           @relation(fields: [paymentId], references: [id])
  user       User               @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([courseId])
}

model LiveSession {
  id             String             @id @default(uuid())
  courseId       String
  title          String
  shortDescription String?
  description    String?
  meetingUrl     String?
  recordingUrl   String?
  scheduledStart DateTime
  scheduledEnd   DateTime
  status         String             @default("scheduled")
  currency       String             @default("TZS")
  isFree         Boolean            @default(true)
  price          Float              @default(0)
  accessLogs     AccessAttemptLog[]
  accessTokens   AccessToken[]
  payments       Payment[]

  @@index([courseId])
  @@index([scheduledStart])
}

model AccessToken {
  id                String      @id @default(uuid())
  tokenHash         String      @unique
  userId            String
  sessionId         String
  deviceFingerprint String
  expiresAt         DateTime
  usedAt            DateTime?
  createdAt         DateTime    @default(now())
  session           LiveSession @relation(fields: [sessionId], references: [id])
  user              User        @relation(fields: [userId], references: [id])

  @@index([tokenHash])
  @@index([userId])
  @@index([sessionId])
}

model AccessAttemptLog {
  id                String       @id @default(uuid())
  userId            String?
  sessionId         String?
  ipAddress         String?
  deviceFingerprint String?
  userAgent         String?
  status            String
  reason            String?
  createdAt         DateTime     @default(now())
  session           LiveSession? @relation(fields: [sessionId], references: [id])
  user              User?        @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([sessionId])
  @@index([createdAt])
}

model Payment {
  id                String       @id @default(uuid())
  userId            String
  amount            Float
  currency          String       @default("TZS")
  provider          String
  providerReference String?      @unique
  status            String
  plan              String
  createdAt         DateTime     @default(now())
  completedAt       DateTime?
  sessionId         String?
  enrollment        Enrollment?
  session           LiveSession? @relation(fields: [sessionId], references: [id])
  user              User         @relation(fields: [userId], references: [id])

  @@index([sessionId])
}

enum UserRole {
  FREE
  PRO
  INSTITUTIONAL
  ADMIN
}


enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
}

model PricingPlan {
  id          String   @id @default(uuid())
  planId      String   @unique  // "free", "pro", "institutional"
  name        String
  price       Float
  currency    String   @default("TZS")
  period      String?
  description String
  features    Json     // Array of {name: string, included: boolean}
  cta         String
  href        String
  popular     Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
